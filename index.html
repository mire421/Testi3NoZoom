<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>EBE Erfassung</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 1rem;
      max-width: 500px;
      margin: auto;
    }

    h2 {
      text-align: center;
      color: #222;
      margin-bottom: 1rem;
    }

    form {
      background: white;
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    label {
      display: block;
      font-weight: 600;
      font-size: 0.9rem;
      margin-top: 0.8rem;
    }

    input, select {
      width: 100%;
      padding: 0.65rem;
      font-size: 16px; /* iPhone-Zoom verhindern */
      margin-top: 0.25rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
      transition: border-color 0.2s;
      -webkit-text-size-adjust: 100%;
    }

    input:focus, select:focus {
      border-color: #007aff;
      outline: none;
    }

    .quick-select {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.3rem;
    }

    .quick-select button {
      flex: 1 1 calc(33.3% - 0.5rem);
      background: #f0f0f0;
      border: none;
      padding: 0.5rem;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .quick-select button:hover {
      background: #007aff;
      color: white;
    }

    button[type="button"] {
      margin-top: 1.5rem;
      width: 100%;
      padding: 0.9rem;
      background: #007aff;
      color: white;
      font-size: 1.1rem;
      border: none;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0, 122, 255, 0.3);
      cursor: pointer;
    }

    button[type="button"]:hover {
      background: #005ecb;
    }
  </style>
</head>
<body>
  <h2>EBE-Erfassung</h2>
  <form id="ebeForm">
    <label>Nachname
      <input type="text" id="nachname" placeholder="Mustermann" />
    </label>

    <label>Vorname
      <input type="text" id="vorname" placeholder="Max" />
    </label>

    <label>Geschlecht</label>
    <div class="quick-select">
      <button type="button" onclick="document.getElementById('geschlecht').value='M'">M</button>
      <button type="button" onclick="document.getElementById('geschlecht').value='W'">W</button>
      <button type="button" onclick="document.getElementById('geschlecht').value='D'">D</button>
    </div>
    <input type="hidden" id="geschlecht" />

    <label>Geburtsdatum
      <input type="text" id="geburtsdatum" placeholder="z. B. 01.01.1990" />
    </label>

    <label>Straße, Hausnummer
      <input type="text" id="strasse" placeholder="Bahnhofstr. 12" />
    </label>

    <label>PLZ
      <input type="text" id="plz" placeholder="70173" />
    </label>

    <label>Wohnort
      <input type="text" id="ort" placeholder="Stuttgart" oninput="autoFillPLZ()" />
    </label>

    <label>Linie</label>
    <div class="quick-select">
      <button type="button" onclick="document.getElementById('linie').value='U1'">U1</button>
      <button type="button" onclick="document.getElementById('linie').value='U2'">U2</button>
      <button type="button" onclick="document.getElementById('linie').value='U3'">U3</button>
      <button type="button" onclick="document.getElementById('linie').value='S1'">S1</button>
      <button type="button" onclick="document.getElementById('linie').value='S2'">S2</button>
      <button type="button" onclick="document.getElementById('linie').value='S3'">S3</button>
    </div>
    <input type="hidden" id="linie" />

    <label>Prüfhaltestelle
      <input type="text" id="haltestelle" placeholder="Hauptbahnhof" />
    </label>

    <label>Prüfernummer
      <input type="text" id="pruefer" placeholder="12345" />
    </label>

    <label>Datum
      <input type="date" id="datum" />
    </label>

    <label>Uhrzeit
      <input type="time" id="uhrzeit" />
    </label>

    <label>Beanstandungsgrund
      <input type="text" id="grund" placeholder="Kein gültiger Fahrausweis" />
    </label>

    <label>Bereits gezahlt (€)
      <input type="number" step="0.01" id="zahlung" value="0.00" />
    </label>

    <button type="button" onclick="generatePDF()">EBE erfassen</button>
  </form>

  <script>
    function autoFillPLZ() {
      const ort = document.getElementById('ort').value.trim().toLowerCase();
      const plzField = document.getElementById('plz');
      const ortPlzMap = {
        "stuttgart": "70173", "esslingen": "73728", "filderstadt": "70794", "waiblingen": "71332"
        // ... (verkürzt für Übersichtlichkeit)
      };
      plzField.value = ortPlzMap[ort] || "";
    }

    const { jsPDF } = window.jspdf;

    function generatePDF() {
      const form = document.forms['ebeForm'];
      const fields = ['nachname', 'vorname', 'geschlecht', 'geburtsdatum', 'strasse', 'plz', 'ort', 'linie', 'haltestelle', 'pruefer', 'datum', 'uhrzeit', 'grund', 'zahlung'];
      const data = {};
      fields.forEach(id => data[id] = form[id].value);

      const today = new Date().toISOString().split('T')[0].replace(/-/g, '');
      const counterKey = 'ebe_counter_' + today;
      const count = (localStorage.getItem(counterKey) || 0) * 1 + 1;
      localStorage.setItem(counterKey, count);

      const belegnummer = `EBE-${today}-${String(count).padStart(3, '0')}`;
      const pdf = new jsPDF({ unit: 'mm', format: [80, 208] });
      let y = 10;
      const margin = 5;
      const maxWidth = 70;

      function addCenteredText(text, size = 10, bold = false) {
        pdf.setFontSize(size);
        pdf.setFont(undefined, bold ? 'bold' : 'normal');
        const textWidth = pdf.getTextWidth(text);
        const x = (80 - textWidth) / 2;
        pdf.text(text, x, y);
        y += size * 0.5 + 1;
      }

      function addLeftText(text, size = 8, bold = false) {
        pdf.setFontSize(size);
        pdf.setFont(undefined, bold ? 'bold' : 'normal');
        const lines = pdf.splitTextToSize(text, maxWidth);
        pdf.text(lines, margin, y);
        y += lines.length * (size * 0.35 + 1);
      }

      function formatDate(input) {
        if (!input) return '';
        const [yyyy, mm, dd] = input.split('-');
        return `${dd}.${mm}.${yyyy}`;
      }

      addCenteredText('Rechnung zur Fahrausweisprüfung', 12);
      addCenteredText(belegnummer, 16, true);
      addCenteredText('bei Rückfragen und Zahlungen angeben', 9);
      y += 2;
      addLeftText(`Nachname: ${data.nachname}`, 10);
      addLeftText(`Vorname: ${data.vorname}`, 10);
      if (data.geschlecht) addLeftText(`Geschlecht: ${data.geschlecht}`, 10);
      if (data.geburtsdatum) addLeftText(`Geburtsdatum: ${data.geburtsdatum}`, 10);
      if (data.strasse) addLeftText(`Straße, Haus-Nr.: ${data.strasse}`, 10);
      if (data.plz || data.ort) addLeftText(`PLZ, Wohnort: ${data.plz} ${data.ort}`, 10);
      if (data.linie) addLeftText(`Linie: ${data.linie}`, 10);
      if (data.haltestelle) addLeftText(`Prüfhaltestelle: ${data.haltestelle}`, 10);
      if (data.pruefer) addLeftText(`Prüfernummer: ${data.pruefer}`, 10);
      if (data.grund || data.datum || data.uhrzeit)
        addLeftText(`Beanstandung: ${data.grund} (${formatDate(data.datum)} ${data.uhrzeit})`, 10);
      y += 2;
      addLeftText('Gemäß § 9 der gemeinsamen Beförderungsbedingungen im VVS beträgt unsere Forderung:', 10);
      addCenteredText('60,00 EUR', 13, true);
      addCenteredText('zahlbar innerhalb von 14 Tagen', 10, true);
      addLeftText(`Bereits gezahlt: ${parseFloat(data.zahlung).toFixed(2)} EUR`);
      y += 2;
      addLeftText('Es erfolgt in jedem Fall eine Prüfung, ob bereits Forderungen gegen Sie gerichtet wurden. Die Begleichung der Forderung ohne konkrete Zuordnung Ihrer Identität stellt keine Erfüllung dar. Das Fahren ohne gültigen Fahrausweis stellt eine Straftat gem. § 265a StGB dar. Es kann zu strafrechtlichen Konsequenzen kommen. Ihre Daten werden für die Bearbeitung des erhöhten Beförderungsentgeltes gemäß der DSGVO verarbeitet.', 8);
      y += 2;
      addCenteredText(`Gültig als Fahrschein am ${formatDate(data.datum)} bis Fahrtende`, 9, true);
      y += 2;
      addLeftText('Bankverbindung:', 10, true);
      addLeftText('Deutsche Bank');
      addLeftText('IBAN: DE1234567890');
      addLeftText('BIC: ABC123');
      addLeftText(`Verwendungszweck: ${belegnummer}`);
      y += 2;
      addLeftText('Kontakt:', 10, true);
      addLeftText('Prüfdienst');
      addLeftText('E-Mail: pruefdienst@abc.de');
      addLeftText('Telefon: 0711 12345');

      const filename = `EBE_${data.nachname}_${data.vorname}_${belegnummer}.pdf`;
      pdf.save(filename);
    }

    window.onload = function() {
      const today = new Date();
      const date = today.toISOString().split('T')[0];
      const time = today.toTimeString().split(' ')[0].substring(0, 5);
      document.getElementById('datum').value = date;
      document.getElementById('uhrzeit').value = time;
    };
  </script>
</body>
</html>
